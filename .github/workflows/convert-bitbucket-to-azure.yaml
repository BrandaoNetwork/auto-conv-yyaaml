name: Convert Bitbucket CI to Azure DevOps Pipeline

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Caminho do reposit贸rio Bitbucket (ex: brandaonetwork1/conv-yaml-out.git)'
        required: true
      destination_repo:
        description: 'URL do reposit贸rio de destino no GitHub'
        required: true

jobs:
  convert_pipeline:
    runs-on: ubuntu-latest
    env:
      BITBUCKET_USER: ${{ secrets.BITBUCKET_USERNAME }}
      BITBUCKET_PASSWORD: ${{ secrets.BITBUCKET_PASSWORD }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      SOURCE_REPO: ${{ github.event.inputs.source_repo }}
      DESTINATION_REPO: ${{ github.event.inputs.destination_repo }}

    steps:
      # Checkout do reposit贸rio atual
      - name: Checkout GitHub Repository
        uses: actions/checkout@v3

      # Clonar o reposit贸rio do Bitbucket
      - name: Clone Bitbucket Repository
        run: |
          echo "Cloning Source Repository: $SOURCE_REPO"
          git clone https://${BITBUCKET_USER}:${BITBUCKET_PASSWORD}@bitbucket.org/${SOURCE_REPO} cloned-repo

      # Listar arquivos clonados
      - name: List Files in Cloned Repo
        run: |
          echo "Files in cloned repository:"
          ls -la cloned-repo

      # Converter o manifesto com OpenAI API
      - name: Convert Manifest with OpenAI API
        run: |
          cd cloned-repo
          if [ -f bitbucket-pipelines.yml ]; then
            echo "Converting manifest..."
            BITBUCKET_CONTENT=$(cat bitbucket-pipelines.yml | sed 's/"/\\"/g' | tr '\n' ' ')
            RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "model": "gpt-4",
                "messages": [
                  {"role": "system", "content": "You are a YAML conversion expert. Convert Bitbucket CI manifests to Azure DevOps pipeline manifests."},
                  {"role": "user", "content": "Convert the following Bitbucket CI pipeline YAML to Azure DevOps pipeline YAML:\n'"$BITBUCKET_CONTENT"'"}
                ]
              }')

            echo $RESPONSE | jq -r '.choices[0].message.content' > azure-pipeline-converted.yml
            echo "Conversion complete."
          else
            echo "No bitbucket-pipelines.yml found."
            exit 1
          fi

      # Upload do arquivo convertido como artefato
      - name: Upload Converted Pipeline
        uses: actions/upload-artifact@v3
        with:
          name: converted-azure-pipeline
          path: cloned-repo/azure-pipeline-converted.yml
